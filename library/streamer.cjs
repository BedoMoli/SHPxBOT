const{mkdirSync:mkdirSync}=require("fs"),chalk=require("chalk"),path=require("path");let ffmpegGlobalProcess=null;function decodeUnicodeEscape(e){return e.replace(/\\u([\d\w]{4})/gi,((e,t)=>String.fromCharCode(parseInt(t,16))))}const videoProcessing=async({liveUrl:e,rtmpServer:t=null,rtmpKey:r=null,isInfiniteMode:o=!1,streamDuration:s=null,baseFilePath:a="",mode:n="stream"})=>{console.log(chalk.blue("Starting the streaming process. Please wait..."));const i=require("child_process"),{existsSync:l}=require("fs");let c,d=null;"restream"===n?t&&r?(c=`${t}${r}`,d=`${a}.flv`):c=`${a}.flv`:c=`${t}${r}`;const generateUniqueFileName=(e,t)=>{let r=0,o=`${e}${r>0?`-${r}`:""}.${t}`;for(;l(o);)r++,o=`${e}${r>0?`-${r}`:""}.${t}`;return o};if(d&&l(d)&&(d=generateUniqueFileName(a,"flv")),l(c)){const e=c.split(".").pop();c=generateUniqueFileName(a,e)}process.stdout.clearLine(0),process.stdout.cursorTo(0);const m=[chalk.white("Live Url : ")+chalk.red(`${e}`),chalk.white("Output Destination : ")+chalk.yellow(`${c}`),chalk.white("Secondary Output : ")+chalk.green(`${d||"Not Applicable"}`)].join("\n"),p=Math.max(0,m.length-chalk.reset(m).length+20),u=chalk.blue("=".repeat(p));process.stdout.write(`${u}\n${m}\n${u}`);const h=["-re","-stream_loop","-1","-i",e,"-r","30","-b:v","2000k","-c:v","libx264","-preset","veryfast","-c:a","aac","-f","flv","-loglevel","info","-hide_banner",c];d&&h.push(d),s&&h.push("-t",s.toString()),ffmpegGlobalProcess=i.spawn("ffmpeg",h);let f=0,g=0,S=0;ffmpegGlobalProcess.stderr.on("data",(e=>{const t=e.toString(),r=t.match(/Duration: (\d{2}):(\d{2}):(\d{2})\.\d{2},/),o=t.match(/time=(\d{2}):(\d{2}):(\d{2})\.\d{2}/);if(r&&(g=3600*parseInt(r[1])+60*parseInt(r[2])+parseInt(r[3])),o){S=3600*parseInt(o[1])+60*parseInt(o[2])+parseInt(o[3]);const e=(S/g*100).toFixed(2);process.stdout.clearLine(0),process.stdout.cursorTo(0),process.stdout.write(chalk.green(`Streaming Progress: [${e}%]  | Time Elapsed: ${S} seconds`))}t.includes("error")&&(f+=1,f>5&&(console.log(chalk.red("\nWe encountered a problem and need to stop. Please try again.")),ffmpegGlobalProcess.kill("SIGINT")))})),ffmpegGlobalProcess.on("close",((e,i)=>{const l=`Streaming process exited with code: ${e} and signal: ${i}`;0!==e?(console.log(chalk.magenta(l)),console.log(chalk.yellow("The streaming process has ended unexpectedly. Attempting to restart..."))):console.log(chalk.green("Streaming completed successfully.")),(o||f<=5&&"restream"===n&&t&&r)&&(console.log(chalk.blue("Restarting in 3 seconds...")),setTimeout((()=>{try{videoProcessing({liveUrl:d,rtmpServer:t,rtmpKey:r,isInfiniteMode:o,streamDuration:s,baseFilePath:a,mode:n})}catch(e){console.error(chalk.red(`Error restarting streaming process: ${e.message}`))}}),3e3))})),process.on("SIGINT",(()=>{console.log(chalk.magenta("Streaming has been stopped. Thank you for using our service.")),ffmpegGlobalProcess&&ffmpegGlobalProcess.kill("SIGINT"),process.exit()}))},reStreamShopee=async({videoUrl:e,rtmpServer:t=null,rtmpKey:r=null,isInfiniteMode:o=!1,streamDuration:s=null})=>new Promise((async(a,n)=>{try{let a=null,n=`${__dirname}/../${e}`,i="stream";if(!e.includes("mp4")&&!e.includes("flv")){if(a=await getShopeeStreamDetails(e),!a)throw new Error("Stream details could not be retrieved.");n=decodeURIComponent(a.play_url),i="restream"}const l=`${__dirname}/../stream_output/${a?.room_id}-${a?.username}`;await videoProcessing({liveUrl:n,rtmpServer:t,rtmpKey:r,isInfiniteMode:o,streamDuration:s,baseFilePath:l,mode:i})}catch(e){n(e),console.error("Error in reStreamShopee function: ",e)}})),streamDownloader=async({videoUrl:e,durasiVideo:t=null,rtmpServer:r=null,rtmpKey:o=null,isInfinite:s=!1})=>{try{const a=getStreamProvider(e);let n=null;switch(a){case"shopee":case"filestream":n=await reStreamShopee({videoUrl:e,streamDuration:t?60*t:null,rtmpServer:r,rtmpKey:o,isInfiniteMode:s});break;case"tiktok":n=await tiktokDownload({videoUrl:e,duration:t?60*parseInt(t):null,rtmpServer:r,rtmpKey:o,isInfiniteMode:s});break;default:throw Error(`Platform "${a}" Not Supported Yet!`)}return n}catch(e){throw Error(e)}},getStreamProvider=e=>{let t="";if(e.includes("http")){t=new URL(e).hostname}else t="filestream";return t.includes("tiktok.com")?"tiktok":t.includes("youtube.com")?"youtube":t.includes("twitch.tv")?"twitch":t.includes("facebook.com")?"facebook":t.includes("tokopedia.com")?"tokopedia":t.includes("shopee")?"shopee":t.includes("file")?"filestream":t},getShopeeStreamDetails=async e=>{const t=new URL(e),r=t.searchParams.get("session");return fetch(`https://${t.hostname}/api/v1/session/${r}`,{headers:{Host:t.hostname,"Sec-Ch-Ua":'"Brave";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',"Sec-Ch-Ua-Mobile":"?0","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","X-Api-Source":"pc","Content-Type":"application/json",Accept:"application/json","X-Shopee-Language":"id","X-Requested-With":"XMLHttpRequest","Sec-Ch-Ua-Platform":'"macOS"',"Sec-Gpc":"1","Accept-Language":"id-ID,id;q=0.6","Sec-Fetch-Site":"same-origin","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"empty",Referer:`https://${t.hostname}/?is_from_login=true&is_from_login=true`,"Accept-Encoding":"gzip, deflate, br"}}).then((async e=>{const t=await e.json();return 0==t.err_code?t?.data?.session:t}))},tiktokStreamData=async e=>{const t=`https://www.tiktok.com/@${e}/live`,r=(await fetch(t,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36"}}).then((e=>e.text()))).match(/room_id=(\d+)/);if(!r)throw new Error("No live stream found");const o=r[1];console.info(`\nFound live stream with room id ${o}!`);const s=`https://www.tiktok.com/api/live/detail/?aid=1988&roomID=${o}`,{LiveRoomInfo:a}=await fetch(s).then((e=>e.json())),{title:n,liveUrl:i}=a;return{title:n,liveUrl:i}},tiktokDownload=async({videoUrl:e,output:t="stream_output",format:r="mp4",duration:o=0,rtmpKey:s=null,rtmpServer:a=null,isInfiniteMode:n=!1})=>new Promise((async(i,l)=>{try{const i=e.split("/"),l=i[i.length-2].replace("@",""),{title:c,liveUrl:d}=await tiktokStreamData(l),m=t.endsWith(r)?t:`${t.replace(/\/$/,"")}/${l}-${Date.now()}.${r}`;mkdirSync(path.dirname(m),{recursive:!0}),await videoProcessing({liveUrl:d,rtmpServer:a,rtmpKey:s,isInfiniteMode:n,streamDuration:o,baseFilePath:m,mode:"restream"}),console.info("\nCtrl+C to stop downloading and exit")}catch(e){l(e)}}));module.exports={ffmpegGlobalProcess:ffmpegGlobalProcess,reStreamShopee:reStreamShopee,getShopeeStreamDetails:getShopeeStreamDetails,decodeUnicodeEscape:decodeUnicodeEscape,streamDownloader:streamDownloader};