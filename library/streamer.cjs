const{mkdirSync:mkdirSync}=require("fs"),chalk=require("chalk"),path=require("path");let ffmpegProcess=null;function decodeUnicode(e){return e.replace(/\\u([\d\w]{4})/gi,((e,t)=>String.fromCharCode(parseInt(t,16))))}const processVideo=async({liveUrl:e,rtmpServer:t=null,rtmpKey:r=null,isInfiniteMode:o=!1,streamDuration:a=0,baseFilePath:s="",mode:i="stream"})=>{console.log(chalk.blue("Starting the streaming process. Please wait..."));const n=require("child_process"),{existsSync:l}=require("fs");let c,d=null;"restream"===i?t&&r?(c=`${t}${r}`,d=`${s}.flv`):c=`${s}.flv`:c=`${t}${r}`;const generateFileName=(e,t)=>{let r=0,o=`${e}${r>0?`-${r}`:""}.${t}`;for(;l(o);)r++,o=`${e}${r>0?`-${r}`:""}.${t}`;return o};if(d&&l(d)&&(d=generateFileName(s,"flv")),l(c)){const e=c.split(".").pop();c=generateFileName(s,e)}process.stdout.clearLine(0),process.stdout.cursorTo(0);const p=[chalk.white("Live Url : ")+chalk.red(`${e}`),chalk.white("Output Destination : ")+chalk.yellow(`${c}`),chalk.white("Secondary Output : ")+chalk.green(`${d||"Not Applicable"}`)].join("\n"),m=Math.max(0,p.length-chalk.reset(p).length+20),u=chalk.blue("=".repeat(m));process.stdout.write(`${u}\n${p}\n${u}`);const h=["-re","-stream_loop","-1","-i",e,"-r","30","-b:v","2000k","-c:v","libx264","-preset","veryfast","-c:a","aac","-f","flv","-loglevel","info","-hide_banner",c];d&&h.push(d),a>0&&h.push("-t",a.toString()),ffmpegProcess=n.spawn("ffmpeg",h);let S=0,f=0,g=0,k=0,w=a>0?new Date(Date.now()+1e3*a).toLocaleTimeString():"N/A";ffmpegProcess.stderr.on("data",(e=>{const t=e.toString(),r=t.match(/Duration: (\d{2}):(\d{2}):(\d{2})\.\d{2},/),o=t.match(/time=(\d{2}):(\d{2}):(\d{2})\.\d{2}/),s=t.match(/size=\s*(\d+)kB/);r&&(f=3600*parseInt(r[1])+60*parseInt(r[2])+parseInt(r[3])),o&&(g=3600*parseInt(o[1])+60*parseInt(o[2])+parseInt(o[3]),a>0&&g>=a&&(console.log(chalk.green("\nStream duration reached. Stopping...")),ffmpegProcess.kill("SIGKILL"))),s&&(k=parseInt(s[1]));const i=a>0?(g/a*100).toFixed(2):"N/A",n=(k/1024).toFixed(2),l=new Date(1e3*g).toISOString().substr(11,8);process.stdout.clearLine(0),process.stdout.cursorTo(0),process.stdout.write(chalk.green(`Progress: [${i}%] | Time Elapsed: ${l} | Downloaded: ${n} MB | Estimated End Time: ${w}`)),t.includes("error")&&(S+=1,S>5&&(console.log(chalk.red("\nWe encountered a problem and need to stop. Please try again.")),ffmpegProcess.kill("RESTART")))})),ffmpegProcess.on("close",((n,l)=>{const c=`Streaming process exited with code: ${n} and signal: ${l}`;0!==n&&"SIGINT"!==l&&"SIGKILL"!==l?(console.log(chalk.magenta(c)),console.log(chalk.yellow("The streaming process has ended unexpectedly. Attempting to restart...")),setTimeout((()=>{const n={liveUrl:o||"restream"===i?d:e,rtmpServer:t,rtmpKey:r,isInfiniteMode:o,streamDuration:a,baseFilePath:s};"restream"!==i&&(n.mode=i),processVideo(n)}),3e3)):"SIGINT"===l||"SIGKILL"===l?(console.log(chalk.yellow("Streaming process was automatically terminated. Thankyou!")),process.exit()):console.log(chalk.green("Streaming completed successfully."))})),process.on("SIGINT",(()=>{console.log(chalk.magenta("Streaming has been stopped. Thank you for using our service.")),ffmpegProcess&&ffmpegProcess.kill("SIGINT"),process.exit()}))},reStreamShopee=async({videoUrl:e,rtmpServer:t=null,rtmpKey:r=null,isInfiniteMode:o=!1,streamDuration:a=0})=>new Promise((async(s,i)=>{try{let s=null,i=`${__dirname}/../${e}`,n="stream";if(!e.includes("mp4")&&!e.includes("flv")){if(s=await getShopeeStreamDetails(e),!s)throw new Error("Stream details could not be retrieved.");i=decodeURIComponent(s.play_url),n="restream"}const l=`${__dirname}/../stream_output/${s?.room_id}-${s?.username}`;await processVideo({liveUrl:i,rtmpServer:t,rtmpKey:r,isInfiniteMode:o,streamDuration:a,baseFilePath:l,mode:n})}catch(e){i(e),console.error("Error in reStreamShopee function: ",e)}})),downloadStream=async({videoUrl:e,durasiVideo:t=0,rtmpServer:r=null,rtmpKey:o=null,isInfinite:a=!1})=>{try{const s=getStreamProvider(e);let i=null;switch(s){case"shopee":case"filestream":i=await reStreamShopee({videoUrl:e,streamDuration:t?60*t:null,rtmpServer:r,rtmpKey:o,isInfiniteMode:a});break;case"tiktok":i=await tiktokDownload({videoUrl:e,duration:t?60*parseInt(t):null,rtmpServer:r,rtmpKey:o,isInfiniteMode:a});break;default:throw Error(`Platform "${s}" Not Supported Yet!`)}return i}catch(e){throw Error(e)}},getStreamProvider=e=>{let t="";return t=e.includes("http")?new URL(e).hostname:"filestream",t.includes("tiktok")?"tiktok":t.includes("youtube")?"youtube":t.includes("twitch")?"twitch":t.includes("facebook")?"facebook":t.includes("tokopedia")?"tokopedia":t.includes("shopee")?"shopee":t.includes("file")?"filestream":t},getShopeeStreamDetails=async e=>{const t=new URL(e),r=t.hostname,o=t.searchParams.get("session");return fetch(`https://${r}/api/v1/session/${o}`,{headers:{Host:`${r}`,"Sec-Ch-Ua":'"Brave";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',"Sec-Ch-Ua-Mobile":"?0","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","X-Api-Source":"pc","Content-Type":"application/json",Accept:"application/json","X-Shopee-Language":"id","X-Requested-With":"XMLHttpRequest","Sec-Ch-Ua-Platform":'"macOS"',"Sec-Gpc":"1","Accept-Language":"id-ID,id;q=0.6","Sec-Fetch-Site":"same-origin","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"empty",Referer:`https://${r}/?is_from_login=true&is_from_login=true`,"Accept-Encoding":"gzip, deflate, br"}}).then((async e=>{const t=await e.json();return 0==t.err_code?t?.data?.session:t}))},tiktokStreamData=async e=>{const t=`https://www.tiktok.com/@${e}/live`,r=(await fetch(t,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36"}}).then((e=>e.text()))).match(/room_id=(\d+)/);if(!r)throw new Error("No live stream found");const o=r[1];console.info(`\nFound live stream with room id ${o}!`);const a=`https://www.tiktok.com/api/live/detail/?aid=1988&roomID=${o}`,{LiveRoomInfo:s}=await fetch(a).then((e=>e.json())),{title:i,liveUrl:n}=s;return{title:i,liveUrl:n}},tiktokDownload=async({videoUrl:e,outputDirectory:t="stream_output",format:r="mp4",duration:o=0,rtmpKey:a=null,rtmpServer:s=null,isInfiniteMode:i=!1})=>new Promise((async(n,l)=>{try{const n=e.split("/"),l=n[n.length-2].replace("@",""),{title:c,liveUrl:d}=await tiktokStreamData(l),p=t.endsWith(r)?t:`${t.replace(/\/$/,"")}/${l}-${Date.now()}.${r}`;mkdirSync(path.dirname(p),{recursive:!0}),await processVideo({liveUrl:d,rtmpServer:s,rtmpKey:a,isInfiniteMode:i,streamDuration:o,baseFilePath:p,mode:"restream"}),console.info("\nCtrl+C to stop downloading and exit")}catch(e){l(e)}}));module.exports={ffmpegProcess:ffmpegProcess,reStreamShopee:reStreamShopee,getShopeeStreamDetails:getShopeeStreamDetails,downloadStream:downloadStream,decodeUnicode:decodeUnicode,tiktokDownload:tiktokDownload};