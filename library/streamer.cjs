const ffmpeg=require("fluent-ffmpeg"),util=require("util"),exec=util.promisify(require("child_process").exec),fs=require("fs").promises,{mkdirSync:mkdirSync}=require("fs"),{isFileExist:isFileExist}=require("./file_helper.cjs"),chalk=require("chalk"),path=require("path"),shell=require("shelljs");let ffmpegGlobalProcess=null;function decodeUnicodeEscape(e){return e.replace(/\\u([\d\w]{4})/gi,((e,t)=>String.fromCharCode(parseInt(t,16))))}const videoProcessing=async({liveUrl:e,rtmpServer:t=null,rtmpKey:o=null,isInfiniteMode:r=!1,streamDuration:i=null,baseFilePath:n="",mode:s="stream"})=>{const a=`${n}.flv`,l=`${n}.mp4`;ffmpegGlobalProcess=ffmpeg(e).inputOptions(["-re","-stream_loop -1"]).outputOptions(["-r 30","-s 720x1280","-b:v 800k","-c:v libx264","-preset superfast","-c:a aac","-f flv","-maxrate 800k","-bufsize 800k","-nostats","-hide_banner","-loglevel error"]),t&&o&&(console.log("Re-Steam started!.."),ffmpegGlobalProcess.output(`${t}/${o}`).format("flv")),i&&ffmpegGlobalProcess.duration(i),"restream"===s&&ffmpegGlobalProcess.output(a).format("flv"),ffmpegGlobalProcess.on("error",((e,t,o)=>{console.error(chalk.red("Error:"),e),console.error("ffmpeg stdout:",t),console.error("ffmpeg stderr:",o),cleanup(ffmpegGlobalProcess)})).on("progress",(e=>{})).on("stderr",(e=>console.log(e))).on("end",(async()=>(console.log("Streaming finished."),r&&await handleStreamEnd(r,a,l,t,o),"Streaming finished."))),ffmpegGlobalProcess.run()},reStreamShopee=async({videoUrl:e,rtmpServer:t=null,rtmpKey:o=null,isInfiniteMode:r=!1,streamDuration:i=null})=>{try{let n=null,s=`${__dirname}/../stream_input/${e}`,a="stream";if(!e.includes("mp4")&&!e.includes("flv")){if(n=await getShopeeStreamDetails(e),!n)throw new Error("Stream details could not be retrieved.");s=decodeURIComponent(n.play_url),a="restream"}const l=`${__dirname}/../stream_output/${n?.room_id}-${n?.username}`;await videoProcessing({liveUrl:s,rtmpServer:t,rtmpKey:o,isInfiniteMode:r,streamDuration:i,baseFilePath:l,mode:a})}catch(e){console.error("Error in reStreamShopee function: ",e)}};async function handleStreamEnd(e,t,o,r,i){await convertFlvToMp4(t,o);const n=await isFileExist(o);if(e){console.log(chalk.green("\nRestarting the stream..."));let e=ffmpeg(n?o:t).inputOptions(["-re","-stream_loop -1"]).output(`${r}/${i}`).format("flv").on("error",(t=>{console.error(chalk.red("Error during infinite streaming:"),t),cleanup(e)})).run()}else console.log(chalk.green("\nConversion finished."))}function cleanup(e){e.kill("SIGKILL"),console.log("Cleaning Up ffmpeg..")}const streamDownloader=async({videoUrl:e,durasiVideo:t=null,rtmpServer:o=null,rtmpKey:r=null,isInfinite:i=!1})=>{try{const n=getStreamProvider(e);let s=null;switch(n){case"shopee":case"filestream":s=await reStreamShopee({videoUrl:e,streamDuration:t?60*t:null,rtmpServer:o,rtmpKey:r,isInfiniteMode:i});break;case"tiktok":s=await tiktokDownload({videoUrl:e,duration:t?60*parseInt(t):null,rtmpServer:o,rtmpKey:r,isInfiniteMode:i});break;default:throw Error(`Platform "${n}" Not Supported Yet!`)}return s}catch(e){throw Error(e)}},getStreamProvider=e=>{let t="";if(e.includes("http")){t=new URL(e).hostname}else t="filestream";return t.includes("tiktok.com")?"tiktok":t.includes("youtube.com")?"youtube":t.includes("twitch.tv")?"twitch":t.includes("facebook.com")?"facebook":t.includes("tokopedia.com")?"tokopedia":t.includes("shopee.co.id")?"shopee":t.includes("file")?"filestream":t},getShopeeStreamDetails=async e=>{const t=new URL(e).searchParams.get("session");return fetch(`https://live.shopee.co.id/api/v1/session/${t}`,{headers:{Host:"live.shopee.co.id","Sec-Ch-Ua":'"Brave";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',"Sec-Ch-Ua-Mobile":"?0","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","X-Api-Source":"pc","Content-Type":"application/json",Accept:"application/json","X-Shopee-Language":"id","X-Requested-With":"XMLHttpRequest","Sec-Ch-Ua-Platform":'"macOS"',"Sec-Gpc":"1","Accept-Language":"id-ID,id;q=0.6","Sec-Fetch-Site":"same-origin","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"empty",Referer:"https://shopee.co.id/?is_from_login=true&is_from_login=true","Accept-Encoding":"gzip, deflate, br"}}).then((async e=>{const t=await e.json();return 0==t.err_code?t?.data?.session:t}))},tiktokStreamData=async e=>{const t=`https://www.tiktok.com/@${e}/live`,o=(await fetch(t,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36"}}).then((e=>e.text()))).match(/room_id=(\d+)/);if(!o)throw new Error("No live stream found");const r=o[1];console.info(`\nFound live stream with room id ${r}!`);const i=`https://www.tiktok.com/api/live/detail/?aid=1988&roomID=${r}`,{LiveRoomInfo:n}=await fetch(i).then((e=>e.json())),{title:s,liveUrl:a}=n;return{title:s,liveUrl:a}},tiktokDownload=async({videoUrl:e,output:t="stream_output",format:o="mp4",duration:r=0,rtmpKey:i=null,rtmpServer:n=null,isInfiniteMode:s=!1})=>{try{const a=e.split("/"),l=a[a.length-2].replace("@",""),{title:c,liveUrl:m}=await tiktokStreamData(l),p=t.endsWith(o)?t:`${t.replace(/\/$/,"")}/${l}-${Date.now()}`;mkdirSync(path.dirname(p),{recursive:!0}),await videoProcessing({liveUrl:m,rtmpServer:n,rtmpKey:i,isInfiniteMode:s,streamDuration:r,baseFilePath:p,mode:"restream"}),console.info(`\nDownloading livestream ${c} to /${p}`),console.info("\nCtrl+C to stop downloading and exit")}catch(e){reject(e)}};async function getVideoFileInfo(e){const{stdout:t}=await exec(`ffprobe.exe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "${e}"`),[o,r]=t.trim().split("x").map(Number);return{width:o,height:r}}async function convertFlvToMp4(e,t){try{const o=await getVideoFileInfo(e),r=`${Math.min(5e3,Math.floor(o.width*o.height/4e3))}k`;await new Promise(((o,i)=>{ffmpeg().input(e).outputOptions(["-movflags frag_keyframe+empty_moov","-c:v libx264","-b:v "+r]).videoCodec("libx264").videoBitrate(r).output(t).on("end",(()=>{console.log("Conversion to MP4 finished."),o()})).on("error",(e=>{console.error("Error during MP4 conversion:",e),i(e)})).run()})),await fs.unlink(e),console.log("FLV file removed:",e)}catch(e){console.error("Error in convertFlvToMp4:",e)}}module.exports={ffmpegGlobalProcess:ffmpegGlobalProcess,streamDownloader:streamDownloader};