import{mkdirSync as e,existsSync as t}from"fs";import r from"chalk";import o from"path";import n from"child_process";let i=null;function s(e){return e.replace(/\\u([\d\w]{4})/gi,((e,t)=>String.fromCharCode(parseInt(t,16))))}const a=async({liveUrl:e,rtmpServer:o=null,rtmpKey:s=null,isInfiniteMode:l=!1,streamDuration:c=null,baseFilePath:p="",mode:m="stream"})=>{let d;console.log(r.blue("Starting the streaming process. Please wait..."));let u=null;"restream"===m?o&&s?(d=`${o}${s}`,u=`${p}.flv`):d=`${p}.flv`:d=`${o}${s}`;const h=(e,r)=>{let o=0,n=`${e}${o>0?`-${o}`:""}.${r}`;for(;t(n);)o++,n=`${e}${o>0?`-${o}`:""}.${r}`;return n};if(u&&t(u)&&(u=h(p,"flv")),t(d)){const e=d.split(".").pop();d=h(p,e)}process.stdout.clearLine(0),process.stdout.cursorTo(0);const f=[r.white("Live Url : ")+r.red(`${e}`),r.white("Output Destination : ")+r.yellow(`${d}`),r.white("Secondary Output : ")+r.green(`${u||"Not Applicable"}`)].join("\n"),g=Math.max(0,f.length-r.reset(f).length+20),v=r.blue("=".repeat(g));process.stdout.write(`${v}\n${f}\n${v}`);const $=["-re","-stream_loop","-1","-i",e,"-r","30","-b:v","2000k","-c:v","libx264","-preset","veryfast","-c:a","aac","-f","flv","-loglevel","info","-hide_banner",d];u&&$.push(u),c&&$.push("-t",c.toString()),i=n.spawn("ffmpeg",$);let w=0,S=0,y=0;i.stderr.on("data",(e=>{const t=e.toString(),o=t.match(/Duration: (\d{2}):(\d{2}):(\d{2})\.\d{2},/),n=t.match(/time=(\d{2}):(\d{2}):(\d{2})\.\d{2}/);if(o&&(S=3600*parseInt(o[1])+60*parseInt(o[2])+parseInt(o[3])),n){y=3600*parseInt(n[1])+60*parseInt(n[2])+parseInt(n[3]);const e=(y/S*100).toFixed(2);process.stdout.clearLine(0),process.stdout.cursorTo(0),process.stdout.write(r.green(`Streaming Progress: [${e}%]  | Time Elapsed: ${y} seconds`))}t.includes("error")&&(w+=1,w>5&&(console.log(r.red("\nWe encountered a problem and need to stop. Please try again.")),i.kill("SIGINT")))})),i.on("close",((e,t)=>{const n=`Streaming process exited with code: ${e} and signal: ${t}`;0!==e?(console.log(r.magenta(n)),console.log(r.yellow("The streaming process has ended unexpectedly. Attempting to restart..."))):console.log(r.green("Streaming completed successfully.")),(l||w<=5&&"restream"===m&&o&&s)&&(console.log(r.blue("Restarting in 3 seconds...")),setTimeout((()=>{try{a({liveUrl:u,rtmpServer:o,rtmpKey:s,isInfiniteMode:l,streamDuration:c,baseFilePath:p,mode:m})}catch(e){console.error(r.red(`Error restarting streaming process: ${e.message}`))}}),3e3))})),process.on("SIGINT",(()=>{console.log(r.magenta("Streaming has been stopped. Thank you for using our service.")),i&&i.kill("SIGINT"),process.exit()}))},l=async({videoUrl:e,rtmpServer:t=null,rtmpKey:r=null,isInfiniteMode:o=!1,streamDuration:n=null})=>new Promise((async(i,s)=>{try{let i=null,s=`${__dirname}/../${e}`,l="stream";if(!e.includes("mp4")&&!e.includes("flv")){if(i=await m(e),!i)throw new Error("Stream details could not be retrieved.");s=decodeURIComponent(i.play_url),l="restream"}const c=`${__dirname}/../stream_output/${i?.room_id}-${i?.username}`;await a({liveUrl:s,rtmpServer:t,rtmpKey:r,isInfiniteMode:o,streamDuration:n,baseFilePath:c,mode:l})}catch(e){s(e),console.error("Error in reStreamShopee function: ",e)}})),c=async({videoUrl:e,durasiVideo:t=null,rtmpServer:r=null,rtmpKey:o=null,isInfinite:n=!1})=>{try{const i=p(e);let s=null;switch(i){case"shopee":case"filestream":s=await l({videoUrl:e,streamDuration:t?60*t:null,rtmpServer:r,rtmpKey:o,isInfiniteMode:n});break;case"tiktok":s=await d({videoUrl:e,duration:t?60*parseInt(t):null,rtmpServer:r,rtmpKey:o,isInfiniteMode:n});break;default:throw Error(`Platform "${i}" Not Supported Yet!`)}return s}catch(e){throw Error(e)}},p=e=>{let t="";if(e.includes("http")){t=new URL(e).hostname}else t="filestream";return t.includes("tiktok.com")?"tiktok":t.includes("youtube.com")?"youtube":t.includes("twitch.tv")?"twitch":t.includes("facebook.com")?"facebook":t.includes("tokopedia.com")?"tokopedia":t.includes("shopee.co.id")?"shopee":t.includes("file")?"filestream":t},m=async e=>{const t=new URL(e),r=t.hostname,o=t.searchParams.get("session");return fetch(`https://live.${r}/api/v1/session/${o}`,{headers:{Host:`live.${r}`,"Sec-Ch-Ua":'"Brave";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',"Sec-Ch-Ua-Mobile":"?0","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","X-Api-Source":"pc","Content-Type":"application/json",Accept:"application/json","X-Shopee-Language":"id","X-Requested-With":"XMLHttpRequest","Sec-Ch-Ua-Platform":'"macOS"',"Sec-Gpc":"1","Accept-Language":"id-ID,id;q=0.6","Sec-Fetch-Site":"same-origin","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"empty",Referer:`https://${r}/?is_from_login=true&is_from_login=true`,"Accept-Encoding":"gzip, deflate, br"}}).then((async e=>{const t=await e.json();return 0==t.err_code?t?.data?.session:t}))},d=async({videoUrl:t,output:r="stream_output",format:n="mp4",duration:i=0,rtmpKey:s=null,rtmpServer:l=null,isInfiniteMode:c=!1})=>new Promise((async(p,m)=>{try{const p=t.split("/"),m=p[p.length-2].replace("@",""),{title:d,liveUrl:u}=await(async e=>{const t=`https://www.tiktok.com/@${e}/live`,r=(await fetch(t,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36"}}).then((e=>e.text()))).match(/room_id=(\d+)/);if(!r)throw new Error("No live stream found");const o=r[1];console.info(`\nFound live stream with room id ${o}!`);const n=`https://www.tiktok.com/api/live/detail/?aid=1988&roomID=${o}`,{LiveRoomInfo:i}=await fetch(n).then((e=>e.json())),{title:s,liveUrl:a}=i;return{title:s,liveUrl:a}})(m),h=r.endsWith(n)?r:`${r.replace(/\/$/,"")}/${m}-${Date.now()}.${n}`;e(o.dirname(h),{recursive:!0}),await a({liveUrl:u,rtmpServer:l,rtmpKey:s,isInfiniteMode:c,streamDuration:i,baseFilePath:h,mode:"restream"}),console.info("\nCtrl+C to stop downloading and exit")}catch(e){m(e)}}));export{i as ffmpegGlobalProcess,l as reStreamShopee,m as getShopeeStreamDetails,s as decodeUnicodeEscape,c as streamDownloader};